<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>AJAX</title>
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <style>
    /*폼*/
    #studentForm {
      background-color: beige;
      padding: 20px;
      width: 300px;
      margin-bottom: 20px;
    }

    input[type="number"],
    input[type="text"] {
      padding: 8px 10px;
      margin-top: 4px;
      margin-bottom: 12px;
      border: none;
    }

    /* 버튼*/
    button {
      background-color: #4CAF50;
      color: white;
      padding: 10px 15px;
      margin: 5px 0;
      border: none;
    }
    /* 학생 목록*/
    #studentList {
      width: 320px;
      margin-top: 10px;
      padding: 15px;
      background-color: #fff;
      border-radius: 8px;
    }

    #studentList div {
      background-color: beige;
      padding: 10px;
      border-radius: 5px;
      margin-bottom: 10px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      width: 700px;
    }

    /* 삭제*/
    #studentList button {
      background-color: red;
      padding: 5px 10px;
      border-radius: 3px;
      font-size: 12px;
    }
  </style>
</head>
<body>
  <h1>학생 추가 및 수정</h1>

  <form id="studentForm" onsubmit="createDataToJSONFile(); return false;">
    <label for="student_id">ID:</label><br>
    <input type="number" id="student_id" required><br>

    <label for="student_name">Name:</label><br>
    <input type="text" id="student_name" required><br>

    <label for="student_age">Age:</label><br>
    <input type="number" id="student_age" required><br>

    <label for="student_phone">Phone:</label><br>
    <input type="number" id="student_phone" required><br>

    <button type="submit">Add Student</button>
  </form>

  <button onclick="updateDataToJSONFile()">Update Student</button>

  <h2>학생 목록</h2>
  <div id="studentList"></div>

  <script>
    // 학생 데이터를 추가하는 함수
    function createDataToJSONFile() {
      const xhr = new XMLHttpRequest();
      xhr.open("POST", "http://localhost:3000/students");
      xhr.setRequestHeader("Content-Type", "application/json;charset=UTF-8");

      let data = {
        id: $("#student_id").val(),
        name: $("#student_name").val(),
        age: $("#student_age").val(),
        phoneNumber: $("#student_phone").val()
      };

      xhr.send(JSON.stringify(data));

      xhr.onload = () => {
        if (xhr.status === 201) {
          alert("등록 성공!");
          getDataFromJSONFile();
        } else {
          alert("등록 실패! 오류 코드: " + xhr.status);
        }
      };
    }

    // 특정 id의 학생 데이터를 업데이트하는 함수
    function updateDataToJSONFile() {
      let id = $("#student_id").val();
      alert("수정할 ID: " + id);
      
      const xhr = new XMLHttpRequest();
      xhr.open("PUT", "http://localhost:3000/students/" + id);
      xhr.setRequestHeader("Content-Type", "application/json;charset=UTF-8");

      let data = {
        name: $("#student_name").val(),
        age: $("#student_age").val(),
        phoneNumber: $("#student_phone").val()
      };

      xhr.send(JSON.stringify(data));

      xhr.onload = () => {
        alert("응답 코드: " + xhr.status);
        if (xhr.status === 200) {
          alert("수정 성공!");
          getDataFromJSONFile(); // 업데이트 후 데이터를 다시 불러오는 함수 호출
        } else {
          alert("수정 실패! 오류 코드: " + xhr.status);
        }
      };
    }

    // 학생 데이터를 불러와 화면에 표시하는 함수
    function getDataFromJSONFile() {
      const xhr = new XMLHttpRequest();
      xhr.open("GET", "http://localhost:3000/students");
      xhr.onload = () => {
        if (xhr.status === 200) {
          const data = JSON.parse(xhr.responseText);
          displayStudents(data);
        } else {
          alert("데이터 불러오기 실패! 오류 코드: " + xhr.status);
        }
      };
      xhr.send();
    }

    // 학생 목록을 화면에 표시하는 함수
    function displayStudents(students) {
      const studentList = document.getElementById("studentList");
      studentList.innerHTML = ""; // 기존 목록 초기화

      students.forEach(student => {
        const studentItem = document.createElement("div");
        studentItem.textContent = `학번: ${student.id} / 이름: ${student.name} / 나이: ${student.age} / 번호: ${student.phoneNumber}`;

        // 삭제 버튼 생성
        const deleteButton = document.createElement("button");
        deleteButton.textContent = "Delete";
        deleteButton.onclick = () => deleteDataFromJSONFile(student.id);

        // 학생 항목에 삭제 버튼 추가
        studentItem.appendChild(deleteButton);
        studentList.appendChild(studentItem);
      });
    }

    function deleteDataFromJSONFile(studentId) {
      const xhr = new XMLHttpRequest();
      xhr.open("DELETE", `http://localhost:3000/students/${studentId}`);
      xhr.onload = () => {
        if (xhr.status === 200 || xhr.status === 204) {
          alert("삭제 성공!");
          getDataFromJSONFile(); // 삭제 후 데이터를 다시 불러오는 함수 호출
        } else {
          alert("삭제 실패! 오류 코드: " + xhr.status);
        }
      };
      xhr.send();
    }

    // 페이지가 로드되면 기존 데이터를 불러옴
    window.onload = function () {
      getDataFromJSONFile();
    };
  </script>
</body>
</html>
